jQuery(function($) {

	"use strict";

	var is_rtl = $('html').attr('dir') == "rtl";

    if ( window.gs_debounce == undefined ) {

        window.gs_debounce = function( fn, threshold ) {
    
            var timeout;
    
            return function gs_debounced() {
    
                if ( timeout ) clearTimeout( timeout );
    
                function gs_delayed() {
                    fn();
                    timeout = null;
                }
    
                timeout = setTimeout( gs_delayed, threshold || 100 );
    
            };
        }
    }


	function gs_testimonial_do_video_popup( $widget ) {

		$widget.magnificPopup({

			type: 'iframe',
			removalDelay: 300,
			delegate: 'a.gstm-video-popup:visible',

			iframe: {
				patterns: {
					youtube: {
						index: 'youtube.com/',
						id: 'v=',
						src: 'https://www.youtube.com/embed/%id%?autoplay=1&mute=1'
					},
					vimeo: {
						index: 'vimeo.com/',
						id: '/',
						src: '//player.vimeo.com/video/%id%?autoplay=1&muted=1'
					}
				},
				srcAction: 'iframe_src',
			},
	
			callbacks: {
				beforeOpen: function() {
					var extraClasses = ['mfp-gstm'];
					extraClasses.push( this.st.el.attr('data-effect') ? this.st.el.attr('data-effect') : 'mfp-fade' );
					// extraClasses.push( this.st.el.attr('data-theme') ? this.st.el.attr('data-theme') : 'gstm-video-popup--default' );
					this.st.mainClass = this.st.mainClass + ' ' + extraClasses.join(' ');
				}
			}
		});

	}

	function gs_testimonial_do_popup( $widget ) {

		$widget.magnificPopup({

			type: 'inline',
			removalDelay: 300,
			delegate: 'a.gstm-popup--link:visible',
			callbacks: {
				beforeOpen: function() {
					var extraClasses = ['mfp-gstm'];
					extraClasses.push( this.st.el.attr('data-effect') ? this.st.el.attr('data-effect') : 'mfp-fade' );
					// extraClasses.push( this.st.el.attr('data-theme') ? this.st.el.attr('data-theme') : 'gstm-video-popup--default' );
					this.st.mainClass = this.st.mainClass + ' ' + extraClasses.join(' ');
				}
			}
		});

	}

	function load_gs_testimonial_carousel_class() {
	
		function GS_Testimonial_Carousel( $widgetBox ) {
	
			this.$widgetContainer = $widgetBox;

			this.$widgetContainer.find('.gs_carousel_swiper')
				.children().addClass('swiper-slide')
				.wrapAll("<div class='swiper'><div class='swiper-wrapper'></div></div>");

			this.$widget = this.$widgetContainer.find('.swiper');

			this.setup();

			this.run();

			return this;
		}
	
		GS_Testimonial_Carousel.prototype.getDefaults = function() {
	
			return {
				slidesPerGroup: 3,
				slidesPerView: 3,
				spaceBetween: 0,
				loop: true,
				speed: 600,
				autoplay: {
					delay: 3000,
					disableOnInteraction: false
				},
				pagination: {
					type: 'bullets',
					clickable: true,
				},
				reverseDirection: false
			}
	
		}

		GS_Testimonial_Carousel.prototype.getOptions = function() {
			return this.$widgetContainer.data( 'carousel-settings' ) || {};
		}

		GS_Testimonial_Carousel.prototype.breakpointsSetup = function() {

			var slidesPerGroup = this.config.slidesPerGroup;
			var columns_small_mobile = 12 / this.config.columns_small_mobile;
			var mobile_columns = 12 / this.config.mobile_columns;
			var tablet_columns = 12 / this.config.tablet_columns;
			var desktop_columns = 12 / this.config.desktop_columns;

			this.config.breakpoints = {
				0: {
					slidesPerView: columns_small_mobile,
					slidesPerGroup: slidesPerGroup > columns_small_mobile ? columns_small_mobile : slidesPerGroup
				},
				576: {
					slidesPerView: mobile_columns,
					slidesPerGroup: slidesPerGroup > mobile_columns ? mobile_columns : slidesPerGroup
				},
				768: {
					slidesPerView: tablet_columns,
					slidesPerGroup: slidesPerGroup > tablet_columns ? tablet_columns : slidesPerGroup
				},
				1025: {
					slidesPerView: desktop_columns,
					slidesPerGroup: slidesPerGroup > desktop_columns ? desktop_columns : slidesPerGroup
				}
			}

		}
	
		GS_Testimonial_Carousel.prototype.setup = function() {
	
			this.config = $.extend( {}, this.getDefaults(), this.getOptions() );

			if ( this.config.speed < 100 ) this.config.speed = 100;
	
			this.config.autoplay.delay = this.config.autoplay_delay;

			if ( ! this.config.isAutoplay ) {
				this.config.autoplay = false;
			}			

			if ( ! this.config.slidesPerView || this.config.slidesPerView !== 'auto' ) {
				this.breakpointsSetup();
			}

			if (this.config.isAutoplay && this.config.reverseDirection ) {
				this.config.autoplay.reverseDirection = true;
			}

			if ( ! this.$widgetContainer.hasClass('carousel_style_1') ) {
				this.config.pagination.dynamicBullets = this.config.dynamicBullets;
			}
			
			if ( this.$widgetContainer.hasClass('carousel-dots--style-two') || this.$widgetContainer.hasClass('carousel-dots--style-three') ) {
				this.config.pagination.dynamicBullets = false;
			}
	
			return this;
	
		}
	
		GS_Testimonial_Carousel.prototype.getConfig = function() {

			var defaults = {
				slidesPerView: 2,
				spaceBetween: 10,
				speed: 400,
				pauseOnMouseEnter: true,
				// pagination: true,
				spaceBetween: 100,
				allowSlideNext: true,
				allowSlidePrev: true,
				centeredSlides: true
			};

			let shortcode_data = this.$widgetContainer.data( 'carousel-settings' );

			var shortcode_settings = {};

			if ( shortcode_settings && Object.keys(shortcode_settings).length ){
				shortcode_settings = {
					slidesPerView: 2,
					spaceBetween: 10,
					speed: shortcode_data.speed,
					pauseOnMouseEnter: true,
					pagination: shortcode_data.pagination,
					spaceBetween: 100,
					allowSlideNext: true,
					allowSlidePrev: true,
					centeredSlides: true
				};
			}
			
			var config = $.extend({}, defaults, shortcode_settings );

			return config;
		}

		GS_Testimonial_Carousel.prototype.setupDots = function() {
			if ( ! this.config.dots ) return this;
			this.$widget.parent().append( '<div class="swiper-pagination"></div>' );
			this.config.pagination.el = this.$widgetContainer.find('.swiper-pagination').get();
			return this;
		}

		GS_Testimonial_Carousel.prototype.setupNavs = function() {
			
			if ( ! this.config.navs ) return this;

			this.$widget.parent().append( '<div class="swiper-nav-buttons">' + this.getPrevBtn() + this.getNextBtn() + '</div>' );

			this.config.navigation = {
				nextEl: this.$widget.find('.swiper-button-next').get(),
				prevEl: this.$widget.find('.swiper-button-prev').get(),
			}

			return this;
		}

		GS_Testimonial_Carousel.prototype.getPrevBtn = function() {
			if ( this.config.carousel_navs_style == 'style-two' ) {
				return '<div class="swiper-button-prev"><svg viewBox="0 0 20 12.38"><path d="M1519.51,1854.73a1.134,1.134,0,0,1-1.51.26,1.856,1.856,0,0,1,0-2l3-3h-15a0.952,0.952,0,0,1-1-.96,1.018,1.018,0,0,1,1-1.04h15l-3-2.99a1.873,1.873,0,0,1,0-2.01,1.157,1.157,0,0,1,1.51.33l5.16,4.99a0.973,0.973,0,0,1,0,1.42Z" transform="translate(-1505 -1842.81)"/></svg></div>';
			} else {
				return '<div class="swiper-button-prev"><svg viewBox="0 0 9.91 17"><path d="M1511,5458.51l-1.41,1.42,8.48,8.48,1.42-1.41Zm-1.41,15.56,1.41,1.42,8.49-8.49-1.42-1.41Z" transform="translate(-1509.59 -5458.5)"/></svg></div>';
			}
		}
	
		GS_Testimonial_Carousel.prototype.getNextBtn = function() {
			if ( this.config.carousel_navs_style == 'style-two' ) {
				return '<div class="swiper-button-next"> <svg viewBox="0 0 20 12.38"><path d="M1519.51,1854.73a1.134,1.134,0,0,1-1.51.26,1.856,1.856,0,0,1,0-2l3-3h-15a0.952,0.952,0,0,1-1-.96,1.018,1.018,0,0,1,1-1.04h15l-3-2.99a1.873,1.873,0,0,1,0-2.01,1.157,1.157,0,0,1,1.51.33l5.16,4.99a0.973,0.973,0,0,1,0,1.42Z" transform="translate(-1505 -1842.81)"/></svg> </div>';
			} else {
				return '<div class="swiper-button-next"> <svg viewBox="0 0 9.91 17"><path d="M1511,5458.51l-1.41,1.42,8.48,8.48,1.42-1.41Zm-1.41,15.56,1.41,1.42,8.49-8.49-1.42-1.41Z" transform="translate(-1509.59 -5458.5)"/></svg> </div>';
			}
		}

		GS_Testimonial_Carousel.prototype.run = function() {

			var that = this;

			if ( this.$widgetContainer.hasClass('carousel_style_1') ) {
				this.config.dots = true;
				this.config.pagination.dynamicBullets = true;
				this.config.initialSlide = 2;
				this.config.pagination.renderBullet = function (index, className) {
					var img = that.$widgetContainer.find('.carousel-thumbnails').children().get(index).outerHTML;
					return '<span class="' + className + '">' + img + '</span>';
				}
			}

			this.setupNavs().setupDots();

			this.config.loop = true;

			this.swiper = new GS_Swiper( this.$widget[0], this.config );
		
			$(window).on('load', function() {
				that.swiper.update();
				setTimeout(function() {
					that.swiper.update();
				}, 200);
			});

			this.navigation();
	
			return this;
		}
	
		GS_Testimonial_Carousel.prototype.navigation = function() {

			var _this = this;

			this.$widgetContainer.find('.swiper-button-next').on('click', function() {
				is_rtl ? _this.swiper.slidePrev() : _this.swiper.slideNext();
			});

			this.$widgetContainer.find('.swiper-button-prev').on('click', function() {
				is_rtl ? _this.swiper.slideNext() : _this.swiper.slidePrev();
			});
		}
	
		$.fn.gs_testimonial_carousel = function() {
			return new GS_Testimonial_Carousel( $(this).first() );
		}
	}

	function gs_testimonial_do_carousel( $widget_box ) {
		// Load carousel class if not loaded
		if ( ! ('gs_testimonial_carousel' in $.fn) ) load_gs_testimonial_carousel_class();
		$widget_box.gs_testimonial_carousel();
	}

	function gs_testimonial_desc_ctrl( $widget_box ) {

		if( $widget_box.hasClass('view-type-masonry') ) return;

		let items = $widget_box.find( '.gs_testimonial_single .box-content > .box-content--wrapper' );
		let data  = JSON.parse( $('.gs_testimonial_container').attr('data-carousel-settings') );
		
		items.each( function(index, item) {

			const lineHeight = parseFloat(window.getComputedStyle(item).lineHeight);

			let maxHeight = lineHeight * data.gs_tm_line_contl;
			
			if( data.gs_tm_line_contl  ) {
				item.style.maxHeight = `${maxHeight}px`;
  				item.style.overflow = 'hidden';
			}

		});
		
	}

	


	function load_filter_by_class($filter_by) {

    function GS_Testimonial_filter_by($wrapper, $filter_by) {

      this.filter_by = $filter_by;

      this.$wrapper = $wrapper;
      this.$widget = this.$wrapper.find(".gs_tstm_filters_wrapper");

      this.filters = {};

      this.initIsotope(this.filter_by);

      this.setFilterEvents(this.filter_by);

      return this;
    }

    GS_Testimonial_filter_by.prototype.initIsotope = function ($filter_by) {
      var find_by = ".gstm-filter-" + $filter_by + "  > li.filter";
      var filter_data = "filter-" + $filter_by;

      if (!this.filters.group) {
        this.filters.group = this.$wrapper
          .find(find_by)
          .first()
          .addClass("active")
          .children("a")
          .data(filter_data);
      }

      this.$filter_widget = this.$widget.gs_isotope({
        itemSelector: ".gs_testimonial_single",
        layoutMode: "fitRows",
        originLeft: !is_rtl,
        filter: this.isotopeFilter.bind(this),
      });
    };

    GS_Testimonial_filter_by.prototype.isotopeFilter = function (
      index,
      item
    ) {
      var $item = $(item);

      var filters = [this.filters.group ? $item.is(this.filters.group) : true];

      return filters.every(function (_filter) {
        return !!_filter;
      });
    };

    GS_Testimonial_filter_by.prototype.setFilterEvents = function ($filter_by) {
      var _this = this;
      var find_by = ".gstm-filter-" + $filter_by + "  > li.filter";
      var filter_data = "filter-" + $filter_by;

      this.$wrapper.find(find_by).on("click", "a", function (e) {
        e.preventDefault();
        _this.filters.group = $(this).data(filter_data);
        $(this).parent().addClass("active").siblings().removeClass("active");
        _this.refreshIsotope();
      });

      $(window).on("load", function () {
        _this.refreshIsotope();
        setTimeout(function () {
          _this.refreshIsotope();
        }, 200);
      });
    };

    GS_Testimonial_filter_by.prototype.refreshIsotope = function () {
      this.$filter_widget.gs_isotope();
    };

    $.fn.gs_testimonial_filter_by = function ($filter_by) {
      return new GS_Testimonial_filter_by($(this).first(), $filter_by);
    };

    return GS_Testimonial_filter_by;
  }

// For ratings
   function gs_testimonial_do_filter_by($gs_filter_wrapper, $filter_by) {
     if (!$gs_filter_wrapper.length) return;
     // Load filter class if not loaded
     if (!$.fn.gs_testimonial_filter) load_filter_by_class($filter_by);

     $gs_filter_wrapper.each(function () {
       $(this).gs_testimonial_filter_by($filter_by);
     });
   }


    function gs_testimonial_widget_single_init( $widget_box ) {

		
		
		if ( $widget_box.hasClass('gstm-has-carousel-swiper') ) {
			gs_testimonial_do_carousel( $widget_box );
		}

		if ( $widget_box.hasClass('gstm-has-video-popup') ) {
			gs_testimonial_do_video_popup( $widget_box );
		}

		if ( $widget_box.hasClass('gstm-has-popup') && ! $widget_box.hasClass('gstm-has-video-popup') ) {
			gs_testimonial_do_popup( $widget_box );
		}


		if ($widget_box.hasClass("gs-filter-by-cats")) {
			gs_testimonial_do_filter_by($widget_box, "cats");
		}

		if ($widget_box.hasClass("gs-filter-by-tags")) {
			gs_testimonial_do_filter_by($widget_box, "tags");
		}

		if ($widget_box.hasClass("gs-filter-by-rats")) {
			gs_testimonial_do_filter_by($widget_box, "rats");
		}


		gs_testimonial_desc_ctrl( $widget_box );

		$widget_box.addClass('gs_testimonial__loaded');

	}

    window.gs_testimonial_init = function() {
		
		var $testimonial_container = $('.gs_testimonial_container');
		
		if ( ! $testimonial_container.length ) return;

		$testimonial_container.each(function() {
			
			if ( ! $(this).parent().is(':visible') ) return;
			
			if ( $(this).data('et-js-processed') ) return;

			if ( $(this).hasClass('gs_testimonial__loaded') ) return;

			$(this).data( 'et-js-processed', 1 );

			gs_testimonial_widget_single_init( $(this) );
			
			gs_debounce( function() {
				jQuery(window).trigger('resize');
			}, 30 )();

		});
	}

    // Init
	gs_testimonial_init();

	// Init on Editor
	$(window).on('gstm:scripts:reprocess', function() {
		gs_testimonial_init();
	});

	// Init on Load
	$(window).on('load', function() {
		gs_testimonial_init();
	});

});

jQuery('body').on( 'click', function() {
    gs_testimonial_init();
    setTimeout(() => {
        gs_testimonial_init();
    }, 200);
});

// If buddyboss is active, fix the popup overflow issue.
jQuery(document).on('click', '.mfp-gstm .mfp-close', function () {
    setTimeout(function () {
        jQuery('html, body').css('overflow', '');
    }, 50);
});